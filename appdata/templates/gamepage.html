
{% extends "master.html" %}
{% block title %} Game page {% endblock %}

{% block content %}
{% load static %}


<body>
    <div class="container-fluid">
        <div class="row gx-0 gy-0"> <!-- Remove grid gaps -->
            <!-- First Column: Bingo Game + Button (Left) -->
            <div class="col-md-8">
                <!-- Bingo Game Box -->
                <div class="box bingo-box">
                    <div class="bingo-grid">
                        {% for activity in activities|slice:":9" %}
                            <div class="bingo-cell">
                                <a href="{% url 'activitypage' activity.id %}">
                                    {{ activity.short_description }}
                                </a>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Button Box (Below Bingo Game) -->
                <div class="button-box">
                    {% if user.is_authenticated %}
                        {% if user in players %}
                            <form method="post" action="{% url 'leave_game' game.id %}">
                                {% csrf_token %}
                                <button type='submit' class="btn btn-danger center-button">Leave game</button>
                            </form>
                        {% else %}
                            <form method="post" action="{% url 'join_game' game.id %}">
                                {% csrf_token %}
                                <button type='submit' class="btn btn-success center-button">Join game</button>
                            </form>
                        {% endif %}
                        {% endif %}
                </div>
            </div>

            <!-- Third Column: Weather API, Players, and Teams (Right) -->
            <div class="col-md-4">
                <!-- Weather API Box -->
                <div class="box equal-box weather-box" style="width: 400px;">
                    <b>Weather for {{ weather_data.city }}</b>
                    {% if weather_data %}
                        <p style="margin: auto" align="left">Temperature: {{ weather_data.temperature }}&deg;C</p>
                        <p style="margin: auto" align="left">Humidity: {{ weather_data.humidity }}%</p>
                        <p style="margin: auto" align="left">Wind Speed: {{ weather_data.wind }} m/s</p>
                    {% else %}
                        <p style="margin: auto">Unable to fetch weather data. Please try again later.</p>
                    {% endif %}
                </div>

                <div id="countdown" class="box equal-box players-box" style="font-size: 40px; width: 400px;">
                    {% if time_data.game_started %}
                        <b>Game played for</b>
                    {% else %}
                        <b>Game starts in</b>
                    {% endif %}
                    <p id="timer" style="font-size: 32px;" align="left">
                                 {{ time_data.hours }}h {{ time_data.minutes }}m {{ time_data.seconds }}s
                    </p>
                </div>

                <script>
                    function updateTimer() {
                        var timerElement = document.getElementById('timer');
                        
                        var timeText = timerElement.textContent.trim();
                        var timeParts = timeText.split(' '); // ["Xh", "Ym", "Zs"]
                        
                        var hours = parseInt(timeParts[0].replace('h', '').trim());
                        var minutes = parseInt(timeParts[1].replace('m', '').trim());
                        var seconds = parseInt(timeParts[2].replace('s', '').trim());
                        
                        {% if time_data.game_started %}
                            seconds++;
                            if (seconds >= 60) {
                                seconds = 0;
                                minutes++;
                            }
                            if (minutes >= 60) {
                                minutes = 0;
                                hours++;
                            }
                        {% else %}
                            if (seconds > 0) {
                                seconds--;
                            } else {
                                if (minutes > 0) {
                                    minutes--;
                                    seconds = 59;
                                } else {
                                    if (hours > 0) {
                                        hours--;
                                        minutes = 59;
                                        seconds = 59;
                                    } else {
                                        clearInterval(timerInterval); 
                                        alert("Game started!"); 
                                        return;
                                    }
                                }
                            }
                        {% endif %}
                
                        timerElement.textContent = hours + 'h ' + minutes + 'm ' + seconds + 's';
                    }
                
                    var timerInterval = setInterval(updateTimer, 1000);
                </script>             
                
                <!-- Players Box -->
                <div class="box equal-box players-box">
                    <b>Players in this game</b>
                    <ul>
                        {% for entry in scoreboards %}
                            <li>{{ entry.user.username }} - {{ entry.points}} points. {{entry.position}}</li>
                        {% endfor %}
                    </ul>
                </div>

                

                <!-- Teams Box -->
                <div class="box equal-box teams-box">
                    <b>Teams in this Game</b>
                    <ul>
                        {% for team in teams %}
                            <li>{{ team.name }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</body>



{% endblock %}
